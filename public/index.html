<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghost Evaluator v15.4</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --bg: #0a0a0f; --bg2: #12121a; --card: #1a1a24; --border: #2a2a3a; --text: #fff; --dim: #888; --green: #00ff88; --red: #ff4466; --yellow: #ffaa00; --cyan: #00ccff; --purple: #aa66ff; --orange: #ff8800; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; font-size: 11px; }
        .container { max-width: 1100px; margin: 0 auto; padding: 4px; }

        /* Alert Banner */
        .alert { padding: 4px 8px; border-radius: 4px; margin-bottom: 6px; display: flex; align-items: center; gap: 4px; font-size: 0.65rem; }
        .alert.hidden { display: none; }
        .alert.warning { background: rgba(255, 170, 0, 0.15); border: 1px solid var(--yellow); color: var(--yellow); }
        .alert.danger { background: rgba(255, 68, 102, 0.15); border: 1px solid var(--red); color: var(--red); }
        .alert.info { background: rgba(0, 204, 255, 0.15); border: 1px solid var(--cyan); color: var(--cyan); }
        .alert.preload { background: rgba(255, 136, 0, 0.15); border: 1px solid var(--orange); color: var(--orange); }

        /* Stats Row - single card with inline items */
        .stats-card { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 6px 10px; margin-bottom: 6px; }
        .stats-row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .stat { display: flex; align-items: center; gap: 3px; }
        .stat-label { font-size: 0.55rem; color: var(--dim); text-transform: uppercase; }
        .stat-value { font-size: 0.8rem; font-weight: bold; }
        .stat-value.green { color: var(--green); }
        .stat-value.red { color: var(--red); }
        .stat-value.yellow { color: var(--yellow); }
        .stat-value.cyan { color: var(--cyan); }
        .stat-sub { font-size: 0.55rem; color: var(--dim); margin-left: 1px; }
        .stat-divider { width: 1px; height: 16px; background: var(--border); }

        /* Badge styles */
        .badge { padding: 2px 6px; border-radius: 8px; font-size: 0.6rem; font-weight: 600; display: inline-block; }
        .badge.green { background: rgba(0, 255, 136, 0.2); color: var(--green); }
        .badge.yellow { background: rgba(255, 170, 0, 0.2); color: var(--yellow); }
        .badge.red { background: rgba(255, 68, 102, 0.2); color: var(--red); }
        .badge.cyan { background: rgba(0, 204, 255, 0.2); color: var(--cyan); }
        .badge.orange { background: rgba(255, 136, 0, 0.2); color: var(--orange); }
        .badge.purple { background: rgba(170, 102, 255, 0.2); color: var(--purple); }

        /* Health bar inline */
        .health-bar { width: 40px; height: 4px; background: var(--bg); border-radius: 2px; overflow: hidden; display: inline-block; vertical-align: middle; margin-left: 4px; }
        .health-bar-fill { height: 100%; border-radius: 2px; }

        /* Drawdown levels inline */
        .dd-levels { display: inline-flex; gap: 2px; vertical-align: middle; margin-left: 4px; }
        .dd-level { width: 8px; height: 4px; border-radius: 2px; background: var(--bg); }
        .dd-level.on { background: var(--yellow); }
        .dd-level.danger { background: var(--red); }

        /* Main Grid - 3 columns */
        .main-grid { display: grid; grid-template-columns: 180px 1fr 180px; gap: 6px; }
        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 600px) { .main-grid { grid-template-columns: 1fr; } }

        /* Cards */
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 8px; }
        .card-title { font-size: 0.65rem; font-weight: 600; color: var(--dim); text-transform: uppercase; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }

        /* Input Card */
        .dir-btns { display: flex; gap: 3px; margin-bottom: 4px; }
        .dir-btn { flex: 1; padding: 8px 4px; border: 1px solid var(--border); border-radius: 4px; font-size: 0.75rem; font-weight: bold; cursor: pointer; background: var(--bg2); transition: all 0.15s; }
        .dir-btn.up { color: var(--green); }
        .dir-btn.up:hover, .dir-btn.up.selected { background: rgba(0, 255, 136, 0.2); border-color: var(--green); }
        .dir-btn.down { color: var(--red); }
        .dir-btn.down:hover, .dir-btn.down.selected { background: rgba(255, 68, 102, 0.2); border-color: var(--red); }
        .input-row { display: flex; gap: 3px; }
        .pct-input { flex: 1; padding: 6px; font-size: 0.85rem; text-align: center; background: var(--bg2); border: 1px solid var(--border); border-radius: 4px; color: var(--text); outline: none; }
        .pct-input:focus { border-color: var(--cyan); }
        .add-btn { padding: 6px 10px; background: linear-gradient(135deg, var(--cyan), var(--purple)); border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; font-size: 0.8rem; }
        .quick-btns { display: flex; gap: 2px; margin-top: 4px; }
        .quick-btn { flex: 1; padding: 3px; background: var(--bg2); border: 1px solid var(--border); border-radius: 3px; color: var(--dim); cursor: pointer; font-size: 0.6rem; }
        .quick-btn:hover { border-color: var(--cyan); color: var(--text); }
        .actions { display: flex; gap: 3px; margin-top: 6px; }
        .act-btn { flex: 1; padding: 4px; background: var(--bg2); border: 1px solid var(--border); border-radius: 3px; color: var(--text); cursor: pointer; font-size: 0.7rem; }
        .act-btn:hover { border-color: var(--cyan); }
        .act-btn.danger:hover { border-color: var(--red); color: var(--red); }

        /* Start Auto-bet Button */
        .start-btn { width: 100%; padding: 8px; margin-top: 6px; background: linear-gradient(135deg, var(--green), var(--cyan)); border: none; border-radius: 4px; color: #000; font-weight: bold; cursor: pointer; font-size: 0.75rem; transition: all 0.2s; }
        .start-btn:hover { transform: scale(1.02); box-shadow: 0 0 10px rgba(0, 255, 136, 0.3); }
        .start-btn.stop { background: linear-gradient(135deg, var(--red), var(--yellow)); color: #fff; }
        .start-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

        /* Blocks Display */
        .blocks-grid { display: flex; flex-wrap: wrap; gap: 2px; max-height: 80px; overflow-y: auto; }
        .blk { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; border-radius: 2px; font-size: 0.55rem; font-weight: bold; }
        .blk.up { background: var(--green); color: #000; }
        .blk.down { background: var(--red); color: #fff; }

        /* Prediction */
        .pred-box { text-align: center; padding: 6px; background: var(--bg2); border-radius: 4px; }
        .pred-dir { font-size: 1.2rem; font-weight: bold; }
        .pred-dir.up { color: var(--green); }
        .pred-dir.down { color: var(--red); }
        .pred-dir.none { color: var(--dim); }
        .pred-pattern { color: var(--cyan); font-size: 0.65rem; margin-top: 2px; }
        .pred-reason { color: var(--dim); font-size: 0.55rem; margin-top: 2px; }

        /* Pending Trade */
        .pending { background: rgba(255, 170, 0, 0.1); border: 1px solid var(--yellow); border-radius: 4px; padding: 4px 8px; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; font-size: 0.65rem; }
        .pending.hidden { display: none; }
        .pending-dir { font-weight: bold; font-size: 0.8rem; }
        .pending-dir.up { color: var(--green); }
        .pending-dir.down { color: var(--red); }

        /* Patterns Table */
        .patterns { font-size: 0.6rem; }
        .patterns table { width: 100%; border-collapse: collapse; }
        .patterns th, .patterns td { padding: 2px 4px; text-align: left; border-bottom: 1px solid var(--border); }
        .patterns th { color: var(--dim); font-size: 0.55rem; text-transform: uppercase; }
        .p-dot { display: inline-block; width: 5px; height: 5px; border-radius: 50%; margin-right: 3px; }
        .p-dot.active { background: var(--green); }
        .p-dot.observing { background: var(--yellow); }
        .p-dot.broken { background: var(--red); }

        /* Bucket badges */
        .bucket-badge { padding: 1px 4px; border-radius: 3px; font-size: 0.5rem; font-weight: 600; }
        .bucket-badge.main { background: rgba(0, 255, 136, 0.2); color: var(--green); }
        .bucket-badge.waiting { background: rgba(255, 170, 0, 0.2); color: var(--yellow); }
        .bucket-badge.bns { background: rgba(170, 102, 255, 0.2); color: var(--purple); }

        /* Bucket Summary Card */
        .bucket-card { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 8px; margin-top: 6px; }
        .bucket-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; }
        .bucket-col { text-align: center; padding: 6px; background: var(--bg2); border-radius: 4px; }
        .bucket-label { font-size: 0.55rem; color: var(--dim); text-transform: uppercase; margin-bottom: 4px; }
        .bucket-count { font-size: 1.2rem; font-weight: bold; }
        .bucket-count.main { color: var(--green); }
        .bucket-count.waiting { color: var(--yellow); }
        .bucket-count.bns { color: var(--purple); }
        .bucket-patterns { font-size: 0.5rem; color: var(--dim); margin-top: 2px; max-height: 30px; overflow-y: auto; }

        /* Profit Tracking Card (AP, AAP, BSP) */
        .profit-card { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 8px; margin-top: 6px; }
        .profit-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .profit-col { text-align: center; padding: 6px; background: var(--bg2); border-radius: 4px; }
        .profit-label { font-size: 0.55rem; color: var(--dim); text-transform: uppercase; margin-bottom: 4px; }
        .profit-value { font-size: 1rem; font-weight: bold; }
        .profit-value.green { color: var(--green); }
        .profit-value.red { color: var(--red); }
        .profit-value.yellow { color: var(--yellow); }
        .profit-desc { font-size: 0.5rem; color: var(--dim); margin-top: 2px; }
        .profit-totals { display: flex; justify-content: space-between; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); }

        /* Trades List */
        .trades { max-height: 150px; overflow-y: auto; font-size: 0.6rem; }
        .trade { display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px solid var(--border); }
        .trade:last-child { border-bottom: none; }
        .trade-win { color: var(--green); }
        .trade-loss { color: var(--red); }

        /* Connection Status */
        .conn { position: fixed; top: 4px; right: 4px; padding: 3px 8px; border-radius: 10px; font-size: 0.6rem; font-weight: 600; z-index: 100; }
        .conn.on { background: rgba(0, 255, 136, 0.2); color: var(--green); }
        .conn.off { background: rgba(255, 68, 102, 0.2); color: var(--red); }

        /* Modal */
        .modal-bg { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-bg.hidden { display: none; }
        .modal { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 10px; max-width: 300px; width: 90%; max-height: 50vh; overflow-y: auto; }
        .modal-title { font-size: 0.75rem; font-weight: 600; margin-bottom: 8px; display: flex; justify-content: space-between; }
        .modal-close { background: none; border: none; color: var(--dim); font-size: 0.9rem; cursor: pointer; }
        .session-item { padding: 6px; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 3px; cursor: pointer; font-size: 0.6rem; }
        .session-item:hover { border-color: var(--cyan); }

        /* Recovery info */
        .rec-info { background: var(--bg2); border-radius: 3px; padding: 4px; font-size: 0.55rem; color: var(--dim); }
    </style>
</head>
<body>
    <div class="conn off" id="conn">Offline</div>
    <div class="container">
        <!-- Alert -->
        <div class="alert hidden" id="alert"><span id="alertIcon">‚ö†Ô∏è</span><span id="alertMsg">Warning</span></div>

        <!-- Pending Trade -->
        <div class="pending hidden" id="pending">
            <div><span style="color:var(--dim)">PENDING:</span> <span class="pending-dir" id="pendingDir">‚ñ≤</span> <span id="pendingPat">-</span></div>
            <span style="color:var(--dim)" id="pendingReason">-</span>
        </div>

        <!-- Stats Card -->
        <div class="stats-card">
            <div class="stats-row">
                <div class="stat"><span class="stat-label">Mode</span><span id="tradingMode" class="badge orange">PRELOAD</span></div>
                <div class="stat-divider"></div>
                <div class="stat"><span class="stat-label">State</span><span id="state"><span class="badge yellow">UNPLAY</span></span></div>
                <div class="stat"><span class="stat-label">Health</span><span class="stat-value green" id="health">100</span><div class="health-bar"><div class="health-bar-fill" id="healthBar" style="width:100%;background:var(--green)"></div></div></div>
                <div class="stat-divider"></div>
                <div class="stat"><span class="stat-label">Blk</span><span class="stat-value cyan" id="blocks">0</span><span class="stat-sub">(run:<span id="run">0</span>)</span></div>
                <div class="stat"><span class="stat-label">Trades</span><span class="stat-value" id="trades">0</span><span class="stat-sub">(<span id="winRate">0%</span>)</span></div>
                <div class="stat-divider"></div>
                <div class="stat"><span class="stat-label">P/L</span><span class="stat-value" id="pnl">R0</span><span class="stat-sub">(<span id="target">0%</span>)</span></div>
                <div class="stat"><span class="stat-label">DD</span><span class="stat-value" id="dd">R0</span><div class="dd-levels" id="ddLevels"><div class="dd-level"></div><div class="dd-level"></div><div class="dd-level"></div><div class="dd-level"></div></div></div>
                <div class="stat"><span class="stat-label">Stake</span><span class="stat-value green" id="stake">100%</span></div>
                <div class="stat-divider"></div>
                <div class="stat"><span class="stat-label">ZZ</span><span id="zzState" class="badge yellow">OFF</span></div>
                <div class="stat"><span class="stat-label">Pocket</span><span class="stat-value cyan" id="zzPocket">1</span></div>
                <div class="stat"><span class="stat-label">Next</span><span id="zzNext" class="badge yellow">ZZ</span></div>
                <div class="stat-divider"></div>
                <div class="stat"><span class="stat-label">SD</span><span id="sdState" class="badge yellow">OFF</span></div>
                <div class="stat"><span class="stat-label">Loss</span><span class="stat-value" id="sdLoss">0</span><span class="stat-sub">/140</span></div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Column 1 - Input & Blocks -->
            <div class="card">
                <div class="card-title">Input <span style="font-weight:normal;font-size:0.55rem">G/R+Enter</span></div>
                <div class="dir-btns">
                    <button class="dir-btn up" id="btnUp" onclick="selDir('up')">‚ñ≤ UP</button>
                    <button class="dir-btn down" id="btnDown" onclick="selDir('down')">‚ñº DN</button>
                </div>
                <div class="input-row">
                    <input type="number" class="pct-input" id="pctIn" placeholder="%" min="0" max="100">
                    <button class="add-btn" onclick="addBlock()">+</button>
                </div>
                <div class="quick-btns">
                    <button class="quick-btn" onclick="setPct(30)">30</button>
                    <button class="quick-btn" onclick="setPct(45)">45</button>
                    <button class="quick-btn" onclick="setPct(55)">55</button>
                    <button class="quick-btn" onclick="setPct(65)">65</button>
                    <button class="quick-btn" onclick="setPct(75)">75</button>
                </div>
                <!-- Start/Stop Auto-bet Button -->
                <button class="start-btn" id="startBtn" onclick="toggleAutobet()">‚ñ∂ START AUTO-BET</button>
                <div class="actions">
                    <button class="act-btn" onclick="undo()">‚Ü©</button>
                    <button class="act-btn" onclick="save()">üíæ</button>
                    <button class="act-btn" onclick="openLoad()">üìÇ</button>
                    <button class="act-btn danger" onclick="clearSession()">üóë</button>
                </div>
                <div class="card-title" style="margin-top:8px;margin-bottom:4px">Blocks</div>
                <div class="blocks-grid" id="blocksGrid"><span style="color:var(--dim)">-</span></div>
            </div>

            <!-- Column 2 - Prediction, Health, Patterns -->
            <div>
                <!-- Prediction + Health -->
                <div class="card">
                    <div style="display:flex;gap:10px;align-items:flex-start">
                        <div class="pred-box" style="flex:1">
                            <div class="pred-dir none" id="predDir">HOLD</div>
                            <div class="pred-pattern" id="predPat">-</div>
                            <div class="pred-reason" id="predReason">No pattern</div>
                        </div>
                        <div style="flex:1;font-size:0.65rem">
                            <div style="margin-bottom:4px"><span class="badge" id="healthBadge">PLAYABLE</span></div>
                            <div style="display:grid;gap:2px">
                                <div><span style="color:var(--dim)">WR:</span> <span id="wrFactor">100%</span> <span style="color:var(--dim)">VD:</span> <span id="verdict">100%</span></div>
                                <div><span style="color:var(--dim)">PT:</span> <span id="patFactor">100%</span> <span style="color:var(--dim)">DD:</span> <span id="ddFactor">100%</span></div>
                            </div>
                            <div class="rec-info hidden" id="recInfo" style="margin-top:4px"></div>
                        </div>
                    </div>
                </div>

                <!-- Profit Tracking (AP, AAP, BSP) -->
                <div class="profit-card">
                    <div class="card-title">Profit Analysis</div>
                    <div class="profit-grid">
                        <div class="profit-col">
                            <div class="profit-label">AP (Actual)</div>
                            <div class="profit-value" id="profitAP">R0</div>
                            <div class="profit-desc">Real trades only</div>
                        </div>
                        <div class="profit-col">
                            <div class="profit-label">AAP (Activation)</div>
                            <div class="profit-value yellow" id="profitAAP">0%</div>
                            <div class="profit-desc">Pattern activation</div>
                        </div>
                        <div class="profit-col">
                            <div class="profit-label">BSP (Bait/Switch)</div>
                            <div class="profit-value" id="profitBSP">0%</div>
                            <div class="profit-desc">Reverse sim (locked)</div>
                        </div>
                    </div>
                    <div class="profit-totals">
                        <span style="color:var(--dim);font-size:0.55rem">TOTALS:</span>
                        <span id="profitTotals" style="font-size:0.6rem">AP: R0 | AAP: 0% | BSP: 0%</span>
                    </div>
                </div>

                <!-- 3-Bucket System -->
                <div class="bucket-card">
                    <div class="card-title">3-Bucket System</div>
                    <div class="bucket-grid">
                        <div class="bucket-col">
                            <div class="bucket-label">MAIN (Play)</div>
                            <div class="bucket-count main" id="bucketMain">0</div>
                            <div class="bucket-patterns" id="bucketMainList">-</div>
                        </div>
                        <div class="bucket-col">
                            <div class="bucket-label">WAITING (No Play)</div>
                            <div class="bucket-count waiting" id="bucketWaiting">0</div>
                            <div class="bucket-patterns" id="bucketWaitingList">-</div>
                        </div>
                        <div class="bucket-col">
                            <div class="bucket-label">B&S (Inverse)</div>
                            <div class="bucket-count bns" id="bucketBns">0</div>
                            <div class="bucket-patterns" id="bucketBnsList">-</div>
                        </div>
                    </div>
                </div>

                <!-- Patterns -->
                <div class="card patterns" style="margin-top:6px">
                    <table><thead><tr><th>Pattern</th><th>Bucket</th><th>Accum</th><th>Run</th><th>Break</th></tr></thead><tbody id="patternsTable"></tbody></table>
                </div>
            </div>

            <!-- Column 3 - Trades & Pocket -->
            <div>
                <div class="card">
                    <div class="card-title">Trades</div>
                    <div class="trades" id="tradesList"><span style="color:var(--dim)">No trades</span></div>
                </div>

                <!-- ZZ Pocket System -->
                <div class="bucket-card" style="margin-top:6px">
                    <div class="card-title">ZZ Pocket System <span id="zzMoveIndicator" class="badge" style="font-size:0.5rem"></span></div>
                    <div class="bucket-grid" style="grid-template-columns:1fr 1fr">
                        <div class="bucket-col" id="pocket1Box" style="border:2px solid transparent; transition:border-color 0.3s">
                            <div class="bucket-label">POCKET 1 (BET)</div>
                            <div id="pocket1Pattern" style="font-size:0.85rem; font-weight:bold"></div>
                            <div class="bucket-patterns" id="pocket1Info"></div>
                        </div>
                        <div class="bucket-col" id="pocket2Box" style="border:2px solid transparent; transition:border-color 0.3s">
                            <div class="bucket-label">POCKET 2 (OBSERVE)</div>
                            <div id="pocket2Pattern" style="font-size:0.85rem; font-weight:bold"></div>
                            <div class="bucket-patterns" id="pocket2Info"></div>
                        </div>
                    </div>
                    <!-- Movement History -->
                    <div id="zzHistory" style="font-size:0.5rem; color:var(--dim); margin-top:6px; max-height:40px; overflow-y:auto"></div>
                </div>

                <!-- Same Direction System -->
                <div class="bucket-card" style="margin-top:6px">
                    <div class="card-title">Same Direction <span id="sdStatusBadge" class="badge yellow">INACTIVE</span></div>
                    <div class="bucket-grid" style="grid-template-columns:1fr 1fr">
                        <div class="bucket-col">
                            <div class="bucket-label">Status</div>
                            <div id="sdStatusText" style="font-size:0.75rem; font-weight:bold; color:var(--dim)">Observing</div>
                            <div class="bucket-patterns" id="sdRunInfo">Run: 0 blocks</div>
                        </div>
                        <div class="bucket-col">
                            <div class="bucket-label">Accum. Loss</div>
                            <div id="sdAccumLoss" style="font-size:1.2rem; font-weight:bold; color:var(--green)">0%</div>
                            <div class="bucket-patterns">Threshold: 140%</div>
                        </div>
                    </div>
                    <!-- Run History -->
                    <div id="sdHistory" style="font-size:0.5rem; color:var(--dim); margin-top:6px; max-height:50px; overflow-y:auto"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal - Load Session -->
    <div class="modal-bg hidden" id="modal" onclick="if(event.target===this)closeLoad()">
        <div class="modal">
            <div class="modal-title">Load Session <button class="modal-close" onclick="closeLoad()">√ó</button></div>
            <div id="sessions"><span style="color:var(--dim)">Loading...</span></div>
        </div>
    </div>

    <script>
        let ws, dir = null, state = {};
        let isLiveMode = false; // false = preload mode, true = live auto-bet mode

        function connect() {
            ws = new WebSocket((location.protocol === 'https:' ? 'wss:' : 'ws:') + '//' + location.host);
            ws.onopen = () => { document.getElementById('conn').className = 'conn on'; document.getElementById('conn').textContent = 'Online'; };
            ws.onclose = () => { document.getElementById('conn').className = 'conn off'; document.getElementById('conn').textContent = 'Offline'; setTimeout(connect, 2000); };
            ws.onmessage = e => handle(JSON.parse(e.data));
        }

        function handle(msg) {
            if (msg.type === 'full_state') {
                state = msg.data;
                // Restore mode from server state if available
                if (msg.data.isLiveMode !== undefined) {
                    isLiveMode = msg.data.isLiveMode;
                }
                update();
            }
            else if (msg.type === 'block_added') { Object.assign(state, msg.data); state.blocks = [...(state.blocks||[]), msg.data.block]; update(); }
            else if (msg.type === 'block_undone') {
                state = msg.data;
                if (msg.data?.isLiveMode !== undefined) {
                    isLiveMode = msg.data.isLiveMode;
                }
                update();
            }
            else if (msg.type === 'sessions_list') { renderSessions(msg.data || []); }
            else if (msg.type === 'mode_changed') { isLiveMode = msg.data.isLiveMode; update(); }
            else if (msg.type === 'error') { alert(msg.message || 'Error'); }
        }

        function send(action, payload = {}) { if (ws?.readyState === 1) ws.send(JSON.stringify({ action, payload })); }
        function selDir(d) { dir = d; document.getElementById('btnUp').classList.toggle('selected', d === 'up'); document.getElementById('btnDown').classList.toggle('selected', d === 'down'); document.getElementById('pctIn').focus(); }
        function setPct(v) { document.getElementById('pctIn').value = v; }

        function addBlock() {
            const p = document.getElementById('pctIn').value;
            if (!dir) return alert('Select direction');
            if (!p || p < 0 || p > 100) return alert('Invalid %');
            // Send block with current mode
            send('add_block', { direction: dir, percentage: p, preloadMode: !isLiveMode });
            document.getElementById('pctIn').value = '';
        }

        function undo() { send('undo'); }
        function save() { if (!state.blocks?.length) return alert('No data'); send('save'); }
        function openLoad() { document.getElementById('modal').classList.remove('hidden'); send('list_sessions'); }
        function closeLoad() { document.getElementById('modal').classList.add('hidden'); }
        function loadSession(p) { send('load', { path: p }); closeLoad(); }
        function clearSession() {
            if (confirm('Clear session?')) {
                send('clear');
                isLiveMode = false; // Reset to preload mode
                update();
            }
        }
        function renderSessions(list) { const el = document.getElementById('sessions'); if (!list.length) { el.innerHTML = '<span style="color:var(--dim)">No sessions</span>'; return; } el.innerHTML = list.map(s => `<div class="session-item" onclick="loadSession('${s.path.replace(/\\/g,'\\\\')}')"><div>${new Date(s.timestamp).toLocaleString()}</div><div style="color:${s.pnl>=0?'var(--green)':'var(--red)'}">${s.pnl>=0?'+':''}R${s.pnl.toFixed(2)}</div></div>`).join(''); }

        // Toggle between preload and live mode
        function toggleAutobet() {
            if (!isLiveMode) {
                // Starting live mode
                if (confirm('Start auto-betting? Trades will be opened from now on.')) {
                    isLiveMode = true;
                    send('set_mode', { isLiveMode: true });
                    update();
                }
            } else {
                // Stopping live mode (back to preload)
                if (confirm('Stop auto-betting? Return to preload mode?')) {
                    isLiveMode = false;
                    send('set_mode', { isLiveMode: false });
                    update();
                }
            }
        }

        function update() {
            const sum = state.summary || {};
            const health = state.sessionHealth || sum.sessionHealth || {};
            const dd = state.drawdown || {};
            const rec = state.recovery || {};
            const reentry = state.reentry || {};

            // Trading Mode indicator
            const modeEl = document.getElementById('tradingMode');
            if (isLiveMode) {
                modeEl.textContent = 'LIVE';
                modeEl.className = 'badge green';
            } else {
                modeEl.textContent = 'PRELOAD';
                modeEl.className = 'badge orange';
            }

            // Start button state
            const startBtn = document.getElementById('startBtn');
            if (isLiveMode) {
                startBtn.textContent = '‚èπ STOP AUTO-BET';
                startBtn.className = 'start-btn stop';
            } else {
                startBtn.textContent = '‚ñ∂ START AUTO-BET';
                startBtn.className = 'start-btn';
            }

            // State badge
            const st = sum.sessionState || 'unplayable';
            const stMap = { playable: ['PLAY', 'green'], unplayable: ['UNPLAY', 'yellow'], p1_mode: ['P1', 'red'], done: ['DONE', 'cyan'] };
            const [stText, stColor] = stMap[st] || [st, 'yellow'];
            document.getElementById('state').innerHTML = `<span class="badge ${stColor}">${stText}</span>`;

            // Health
            const score = health.score || 100;
            const hEl = document.getElementById('health');
            hEl.textContent = score.toFixed(0);
            hEl.className = 'stat-value ' + (score >= 70 ? 'green' : score >= 50 ? 'yellow' : 'red');
            const bar = document.getElementById('healthBar');
            bar.style.width = score + '%';
            bar.style.background = score >= 70 ? 'var(--green)' : score >= 50 ? 'var(--yellow)' : 'var(--red)';

            // Health badge
            const lvl = health.level || 'playable';
            const hBadge = document.getElementById('healthBadge');
            hBadge.textContent = lvl.toUpperCase();
            hBadge.className = 'badge ' + (lvl === 'playable' ? 'green' : lvl === 'caution' ? 'yellow' : 'red');

            // Blocks & Run
            document.getElementById('blocks').textContent = sum.blockCount || 0;
            document.getElementById('run').textContent = state.runData?.currentLength || 0;

            // Trades & Win Rate
            document.getElementById('trades').textContent = sum.tradeCount || 0;
            document.getElementById('winRate').textContent = (sum.winRate || 0).toFixed(0) + '%';

            // P/L & Target
            const pnl = sum.pnlTotal || 0;
            const pnlEl = document.getElementById('pnl');
            pnlEl.textContent = (pnl >= 0 ? '+' : '') + 'R' + pnl.toFixed(0);
            pnlEl.className = 'stat-value ' + (pnl >= 0 ? 'green' : 'red');
            document.getElementById('target').textContent = (sum.targetProgress || 0).toFixed(0) + '%';

            // Drawdown
            const ddVal = dd.currentDrawdown || 0;
            const ddEl = document.getElementById('dd');
            ddEl.textContent = 'R' + ddVal.toFixed(0);
            ddEl.className = 'stat-value ' + (ddVal >= 0 ? 'green' : 'red');
            const ddLvl = dd.level || 0;
            document.querySelectorAll('#ddLevels .dd-level').forEach((el, i) => { el.className = 'dd-level' + (i < ddLvl ? (i >= 2 ? ' danger' : ' on') : ''); });

            // Stake
            const stake = sum.stakeMultiplier || 1;
            const stakeEl = document.getElementById('stake');
            stakeEl.textContent = Math.round(stake * 100) + '%';
            stakeEl.className = 'stat-value ' + (stake < 1 ? 'yellow' : 'green');

            // Health factors
            document.getElementById('wrFactor').textContent = ((health.winRateFactor || 1) * 100).toFixed(0) + '%';
            document.getElementById('verdict').textContent = ((health.verdictQualityFactor || 1) * 100).toFixed(0) + '%';
            document.getElementById('patFactor').textContent = ((health.patternReliabilityFactor || 1) * 100).toFixed(0) + '%';
            document.getElementById('ddFactor').textContent = ((health.drawdownFactor || 1) * 100).toFixed(0) + '%';

            // Recovery info
            const recInfo = document.getElementById('recInfo');
            if (rec.isInRecoveryMode) { recInfo.classList.remove('hidden'); recInfo.innerHTML = `<b>Recovery</b> | Blocks: ${rec.blocksInRecovery} | Shadow WR: ${(rec.shadowWinRate*100).toFixed(0)}%`; }
            else if (reentry.isInReentry) { recInfo.classList.remove('hidden'); recInfo.innerHTML = `<b>Re-Entry</b> | ${reentry.trialTradesCompleted}/${reentry.totalTrialTrades} | Wins: ${reentry.trialWins}`; }
            else recInfo.classList.add('hidden');

            // Blocks grid
            const bg = document.getElementById('blocksGrid');
            if (state.blocks?.length) { bg.innerHTML = state.blocks.map(b => `<div class="blk ${b.dir > 0 ? 'up' : 'down'}">${b.pct.toFixed(0)}</div>`).join(''); bg.scrollTop = bg.scrollHeight; }
            else bg.innerHTML = '<span style="color:var(--dim)">No blocks</span>';

            // Prediction
            const pred = state.prediction || {};
            const predDir = document.getElementById('predDir');
            if (pred.hasPrediction) { predDir.textContent = pred.direction > 0 ? '‚ñ≤ UP' : '‚ñº DOWN'; predDir.className = 'pred-dir ' + (pred.direction > 0 ? 'up' : 'down'); document.getElementById('predPat').textContent = pred.pattern + ' (' + pred.confidence + '%)'; }
            else { predDir.textContent = 'HOLD'; predDir.className = 'pred-dir none'; document.getElementById('predPat').textContent = '-'; }
            document.getElementById('predReason').textContent = pred.reason || '';

            // Pending (only show in live mode)
            const pendEl = document.getElementById('pending');
            if (state.pendingTrade && isLiveMode) { pendEl.classList.remove('hidden'); const pd = document.getElementById('pendingDir'); pd.textContent = state.pendingTrade.direction > 0 ? '‚ñ≤' : '‚ñº'; pd.className = 'pending-dir ' + (state.pendingTrade.direction > 0 ? 'up' : 'down'); document.getElementById('pendingPat').textContent = state.pendingTrade.pattern; document.getElementById('pendingReason').textContent = state.pendingTrade.reason; }
            else pendEl.classList.add('hidden');

            // 3-Bucket System
            const buckets = state.buckets || {};
            const bucketSummary = buckets.summary || { main: [], waiting: [], bns: [], stats: { mainCount: 0, waitingCount: 0, bnsCount: 0 } };
            const patternBucketStates = buckets.patternStates || {};

            // Bucket counts
            document.getElementById('bucketMain').textContent = bucketSummary.stats.mainCount || 0;
            document.getElementById('bucketWaiting').textContent = bucketSummary.stats.waitingCount || 0;
            document.getElementById('bucketBns').textContent = bucketSummary.stats.bnsCount || 0;

            // Bucket pattern lists
            document.getElementById('bucketMainList').textContent = bucketSummary.main?.length ? bucketSummary.main.join(', ') : '-';
            document.getElementById('bucketWaitingList').textContent = bucketSummary.waiting?.length ? bucketSummary.waiting.join(', ') : '-';
            document.getElementById('bucketBnsList').textContent = bucketSummary.bns?.length ? bucketSummary.bns.join(', ') : '-';

            // Patterns with bucket info
            const pt = document.getElementById('patternsTable');
            if (state.patterns?.length) {
                pt.innerHTML = state.patterns.sort((a,b) => (b.allTimeProfit||0) - (a.allTimeProfit||0)).map(p => {
                    const bucketState = patternBucketStates[p.pattern] || { bucket: 'WAITING', lastRunProfit: 0, cumulativeProfit: 0 };
                    const bucket = bucketState.bucket || 'WAITING';
                    const bucketClass = bucket === 'MAIN' ? 'main' : bucket === 'BNS' ? 'bns' : 'waiting';
                    const bucketLabel = bucket === 'MAIN' ? 'M' : bucket === 'BNS' ? 'B' : 'W';
                    return `<tr>
                        <td><span class="p-dot ${p.state}"></span>${p.pattern}</td>
                        <td><span class="bucket-badge ${bucketClass}">${bucketLabel}</span></td>
                        <td style="color:${p.cumulativeProfit>=0?'var(--green)':'var(--red)'}">${p.cumulativeProfit.toFixed(0)}</td>
                        <td style="color:${p.lastRunProfit>=0?'var(--green)':'var(--red)'}">${p.lastRunProfit.toFixed(0)}</td>
                        <td style="color:${(p.breakRunProfit||0)>=0?'var(--green)':'var(--red)'}">${(p.breakRunProfit||0).toFixed(0)}</td>
                    </tr>`;
                }).join('');
            }

            // Trades
            const tl = document.getElementById('tradesList');
            if (state.trades?.length) { tl.innerHTML = state.trades.slice().reverse().slice(0,12).map(t => `<div class="trade"><span>#${t.id} ${t.pattern}</span><span class="${t.isWin?'trade-win':'trade-loss'}">${t.isWin?'W':'L'} ${t.isWin?'+':''}R${t.pnl.toFixed(0)}</span></div>`).join(''); }
            else tl.innerHTML = '<span style="color:var(--dim)">No trades</span>';

            // Alert - show preload mode alert when in preload
            const alertEl = document.getElementById('alert');
            const alertIcon = document.getElementById('alertIcon');
            const alertMsg = document.getElementById('alertMsg');

            if (!isLiveMode && state.blocks?.length > 0) {
                // Preload mode with blocks
                alertEl.classList.remove('hidden');
                alertEl.className = 'alert preload';
                alertIcon.textContent = '‚è∏';
                alertMsg.textContent = `PRELOAD MODE - ${state.blocks.length} blocks loaded. Click "Start Auto-bet" to begin trading.`;
            }
            else if (sum.isSessionStopped && sum.sessionStopReason) { alertEl.classList.remove('hidden'); alertEl.className = 'alert danger'; alertIcon.textContent = 'üö´'; alertMsg.textContent = sum.sessionStopReason; }
            else if (lvl === 'caution') { alertEl.classList.remove('hidden'); alertEl.className = 'alert warning'; alertIcon.textContent = '‚ö†Ô∏è'; alertMsg.textContent = `Health declining: ${score.toFixed(0)}/100`; }
            else alertEl.classList.add('hidden');

            // ZZ State Display
            const zzState = state.zzState || {};
            const zzStateEl = document.getElementById('zzState');
            const zzPocketEl = document.getElementById('zzPocket');
            const zzNextEl = document.getElementById('zzNext');

            // ZZ State badge
            const zzCurrentState = zzState.currentState || 'inactive';
            if (zzCurrentState === 'zz_active') {
                zzStateEl.textContent = 'ZZ';
                zzStateEl.className = 'badge green';
            } else if (zzCurrentState === 'anti_zz_active') {
                zzStateEl.textContent = 'ANTI';
                zzStateEl.className = 'badge purple';
            } else {
                zzStateEl.textContent = 'OFF';
                zzStateEl.className = 'badge yellow';
            }

            // Pocket display
            const pocket = zzState.currentPocket || 1;
            zzPocketEl.textContent = pocket;
            zzPocketEl.className = 'stat-value ' + (pocket === 1 ? 'green' : 'red');

            // Next run indicator (will it be Anti-ZZ?)
            const nextIsAntiZZ = zzState.previousRunFirstBetFailed || false;
            if (nextIsAntiZZ) {
                zzNextEl.textContent = 'ANTI';
                zzNextEl.className = 'badge purple';
            } else {
                zzNextEl.textContent = 'ZZ';
                zzNextEl.className = 'badge cyan';
            }

            // ZZ Pocket Card Update - NEW: Shows BOTH ZZ and AntiZZ in their respective pockets
            const pocket1Pattern = document.getElementById('pocket1Pattern');
            const pocket1Info = document.getElementById('pocket1Info');
            const pocket2Pattern = document.getElementById('pocket2Pattern');
            const pocket2Info = document.getElementById('pocket2Info');
            const pocket1Box = document.getElementById('pocket1Box');
            const pocket2Box = document.getElementById('pocket2Box');
            const zzMoveIndicator = document.getElementById('zzMoveIndicator');
            const zzHistory = document.getElementById('zzHistory');

            // NEW: Get separate pocket assignments for ZZ and AntiZZ
            const zzPocketVal = zzState.zzPocket || 1;
            const antiZZPocketVal = zzState.antiZZPocket || 2;
            const activePattern = zzState.activePattern || null;
            const zzPrevProfit = zzState.zzPreviousRunProfit || 0;
            const antiZZPrevProfit = zzState.antiZZPreviousRunProfit || 0;
            const zzRunProfit = zzState.zzCurrentRunProfit || 0;
            const antiZZRunProfit = zzState.antiZZCurrentRunProfit || 0;
            const movementHistory = zzState.movementHistory || [];

            // DEBUG: Log ZZ state
            console.log('[ZZ UI] ZZ Pocket:', zzPocketVal, 'AntiZZ Pocket:', antiZZPocketVal, 'Active:', activePattern);

            // Build patterns in each pocket
            let pocket1Patterns = [];
            let pocket2Patterns = [];

            // Place ZZ in its pocket
            if (zzPocketVal === 1) {
                pocket1Patterns.push({
                    name: 'ZZ',
                    color: activePattern === 'ZZ' ? 'var(--green)' : 'var(--cyan)',
                    prevProfit: zzPrevProfit,
                    runProfit: zzRunProfit,
                    isActive: activePattern === 'ZZ'
                });
            } else {
                pocket2Patterns.push({
                    name: 'ZZ',
                    color: 'var(--dim)',
                    prevProfit: zzPrevProfit,
                    runProfit: zzRunProfit,
                    isActive: false
                });
            }

            // Place AntiZZ in its pocket
            if (antiZZPocketVal === 1) {
                pocket1Patterns.push({
                    name: 'AntiZZ',
                    color: activePattern === 'AntiZZ' ? 'var(--purple)' : 'var(--cyan)',
                    prevProfit: antiZZPrevProfit,
                    runProfit: antiZZRunProfit,
                    isActive: activePattern === 'AntiZZ'
                });
            } else {
                pocket2Patterns.push({
                    name: 'AntiZZ',
                    color: 'var(--dim)',
                    prevProfit: antiZZPrevProfit,
                    runProfit: antiZZRunProfit,
                    isActive: false
                });
            }

            // Highlight Pocket 1 if it has the active pattern
            const hasActiveInP1 = pocket1Patterns.some(p => p.isActive);
            pocket1Box.style.borderColor = hasActiveInP1 ? (activePattern === 'ZZ' ? 'var(--green)' : 'var(--purple)') : 'var(--cyan)';
            pocket2Box.style.borderColor = pocket2Patterns.length > 0 ? 'var(--red)' : 'transparent';

            // Render Pocket 1 patterns
            if (pocket1Patterns.length > 0) {
                pocket1Pattern.innerHTML = pocket1Patterns.map(p =>
                    `<span style="color:${p.color}">${p.name}</span>`
                ).join(' ');
                pocket1Info.innerHTML = pocket1Patterns.map(p => {
                    let info = `<span style="color:${p.prevProfit >= 0 ? 'var(--green)' : 'var(--red)'}">${p.name}: ${p.prevProfit >= 0 ? '+' : ''}${p.prevProfit.toFixed(0)}%</span>`;
                    if (p.isActive && p.runProfit !== 0) {
                        const runColor = p.runProfit >= 0 ? 'var(--green)' : 'var(--red)';
                        info += ` <span style="color:${runColor}">(run: ${p.runProfit >= 0 ? '+' : ''}${p.runProfit.toFixed(0)}%)</span>`;
                    }
                    return info;
                }).join('<br>');
            } else {
                pocket1Pattern.innerHTML = '<span style="color:var(--dim)">-</span>';
                pocket1Info.textContent = '';
            }

            // Render Pocket 2 patterns
            if (pocket2Patterns.length > 0) {
                pocket2Pattern.innerHTML = pocket2Patterns.map(p =>
                    `<span style="color:${p.color}">${p.name}</span>`
                ).join(' ');
                pocket2Info.innerHTML = pocket2Patterns.map(p =>
                    `<span style="color:var(--red)">${p.name}: ${p.prevProfit.toFixed(0)}%</span>`
                ).join('<br>');
            } else {
                pocket2Pattern.innerHTML = '<span style="color:var(--dim)">-</span>';
                pocket2Info.textContent = '';
            }

            // Show movement indicator
            if (movementHistory.length > 0) {
                const lastMove = movementHistory[movementHistory.length - 1];
                zzMoveIndicator.textContent = `${lastMove.pattern} ‚ÜíP${lastMove.toPocket}`;
                zzMoveIndicator.className = lastMove.toPocket === 1 ? 'badge green' : 'badge red';
            } else {
                zzMoveIndicator.textContent = '';
                zzMoveIndicator.className = 'badge';
            }

            // Show movement history (last 5)
            if (movementHistory.length > 0) {
                const recentMoves = movementHistory.slice(-5).reverse();
                zzHistory.innerHTML = recentMoves.map(m =>
                    `<span style="color:${m.toPocket === 1 ? 'var(--green)' : 'var(--red)'}">${m.pattern} P${m.fromPocket}‚ÜíP${m.toPocket} (${m.triggerProfit >= 0 ? '+' : ''}${m.triggerProfit.toFixed(0)}%)</span>`
                ).join(' | ');
            } else {
                zzHistory.innerHTML = '<span style="color:var(--dim)">No movements</span>';
            }

            // Profit Tracking (AP, AAP, BSP)
            const profitData = state.profitTracking?.totals || sum.profitTracking || { actualProfit: 0, activationAccumulatedProfit: 0, baitSwitchProfit: 0 };

            // AP (Actual Profit) - from real trades
            const ap = profitData.actualProfit || 0;
            const apEl = document.getElementById('profitAP');
            if (apEl) {
                apEl.textContent = (ap >= 0 ? '+' : '') + 'R' + ap.toFixed(0);
                apEl.className = 'profit-value ' + (ap >= 0 ? 'green' : 'red');
            }

            // AAP (Accumulated Activation Profit) - pattern activation accumulation
            const aap = profitData.activationAccumulatedProfit || 0;
            const aapEl = document.getElementById('profitAAP');
            if (aapEl) {
                aapEl.textContent = (aap >= 0 ? '+' : '') + aap.toFixed(0) + '%';
                aapEl.className = 'profit-value yellow';
            }

            // BSP (Bait & Switch Profit) - reverse simulation during locked periods
            const bsp = profitData.baitSwitchProfit || 0;
            const bspEl = document.getElementById('profitBSP');
            if (bspEl) {
                bspEl.textContent = (bsp >= 0 ? '+' : '') + bsp.toFixed(0) + '%';
                bspEl.className = 'profit-value ' + (bsp >= 0 ? 'green' : 'red');
            }

            // Totals row
            const totalsEl = document.getElementById('profitTotals');
            if (totalsEl) {
                totalsEl.innerHTML =
                    `<span class="${ap >= 0 ? 'green' : 'red'}">AP: ${ap >= 0 ? '+' : ''}R${ap.toFixed(0)}</span> | ` +
                    `<span class="yellow">AAP: ${aap >= 0 ? '+' : ''}${aap.toFixed(0)}%</span> | ` +
                    `<span class="${bsp >= 0 ? 'green' : 'red'}">BSP: ${bsp >= 0 ? '+' : ''}${bsp.toFixed(0)}%</span>`;
            }

            // Same Direction State Display
            const sdState = state.sameDirectionState || {};
            const sdActive = sdState.active || false;
            const sdAccumLoss = sdState.accumulatedLoss || 0;
            const sdRunBlocks = sdState.currentRunBlocks || [];
            const sdRunDir = sdState.currentRunDirection;
            const sdHistory = sdState.runHistory || [];

            // Stats bar indicators
            const sdStateEl = document.getElementById('sdState');
            const sdLossEl = document.getElementById('sdLoss');

            if (sdActive) {
                sdStateEl.textContent = 'ON';
                sdStateEl.className = 'badge green';
            } else {
                sdStateEl.textContent = 'OFF';
                sdStateEl.className = 'badge yellow';
            }

            sdLossEl.textContent = sdAccumLoss.toFixed(0);
            sdLossEl.className = 'stat-value ' + (sdAccumLoss > 100 ? 'red' : sdAccumLoss > 50 ? 'yellow' : 'green');

            // Same Direction Card
            const sdStatusBadge = document.getElementById('sdStatusBadge');
            const sdStatusText = document.getElementById('sdStatusText');
            const sdRunInfo = document.getElementById('sdRunInfo');
            const sdAccumLossEl = document.getElementById('sdAccumLoss');
            const sdHistoryEl = document.getElementById('sdHistory');

            // Status badge
            if (sdActive) {
                sdStatusBadge.textContent = 'ACTIVE';
                sdStatusBadge.className = 'badge green';
                sdStatusText.textContent = 'Betting Continuation';
                sdStatusText.style.color = 'var(--green)';
            } else {
                sdStatusBadge.textContent = 'INACTIVE';
                sdStatusBadge.className = 'badge yellow';
                sdStatusText.textContent = 'Observing';
                sdStatusText.style.color = 'var(--dim)';
            }

            // Run info
            const runDirText = sdRunDir === 1 ? '‚ñ≤' : sdRunDir === -1 ? '‚ñº' : '-';
            sdRunInfo.innerHTML = `Run: ${sdRunBlocks.length} blocks ${runDirText}`;

            // Accumulated loss display
            sdAccumLossEl.textContent = sdAccumLoss.toFixed(0) + '%';
            sdAccumLossEl.style.color = sdAccumLoss > 100 ? 'var(--red)' : sdAccumLoss > 50 ? 'var(--yellow)' : 'var(--green)';

            // Run history (last 5)
            if (sdHistory.length > 0) {
                const recentRuns = sdHistory.slice(-5).reverse();
                sdHistoryEl.innerHTML = recentRuns.map(r => {
                    const dirIcon = r.direction === 1 ? '‚ñ≤' : '‚ñº';
                    const profitColor = r.runProfit >= 0 ? 'var(--green)' : 'var(--red)';
                    let tag = '';
                    if (r.wasActivation) tag = ' <span style="color:var(--cyan)">[ACT]</span>';
                    if (r.wasDeactivation) tag = ' <span style="color:var(--red)">[CUT]</span>';
                    return `<span>${dirIcon}${r.runLength} <span style="color:${profitColor}">${r.runProfit >= 0 ? '+' : ''}${r.runProfit.toFixed(0)}%</span>${tag}</span>`;
                }).join(' | ');
            } else {
                sdHistoryEl.innerHTML = '<span style="color:var(--dim)">No runs yet</span>';
            }
        }

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') { closeLoad(); return; }
            if (e.target.tagName === 'INPUT') { if (e.key === 'Enter') addBlock(); return; }
            if (e.key.toLowerCase() === 'g') { selDir('up'); document.getElementById('pctIn').focus(); }
            if (e.key.toLowerCase() === 'r') { selDir('down'); document.getElementById('pctIn').focus(); }
            if (e.key.toLowerCase() === 'u') undo();
            if (e.key.toLowerCase() === 's' && !e.ctrlKey) { e.preventDefault(); save(); }
            if (e.key === ' ') { e.preventDefault(); toggleAutobet(); } // Spacebar to toggle
        });

        connect();
    </script>
</body>
</html>
