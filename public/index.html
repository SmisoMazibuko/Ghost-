<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghost Evaluator v15.1</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --bg: #0a0a0f; --bg2: #12121a; --card: #1a1a24; --border: #2a2a3a; --text: #fff; --dim: #888; --green: #00ff88; --red: #ff4466; --yellow: #ffaa00; --cyan: #00ccff; --purple: #aa66ff; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; font-size: 11px; }
        .container { max-width: 1100px; margin: 0 auto; padding: 4px; }

        /* Alert Banner */
        .alert { padding: 4px 8px; border-radius: 4px; margin-bottom: 6px; display: flex; align-items: center; gap: 4px; font-size: 0.65rem; }
        .alert.hidden { display: none; }
        .alert.warning { background: rgba(255, 170, 0, 0.15); border: 1px solid var(--yellow); color: var(--yellow); }
        .alert.danger { background: rgba(255, 68, 102, 0.15); border: 1px solid var(--red); color: var(--red); }
        .alert.info { background: rgba(0, 204, 255, 0.15); border: 1px solid var(--cyan); color: var(--cyan); }

        /* Stats Row - single card with inline items */
        .stats-card { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 6px 10px; margin-bottom: 6px; }
        .stats-row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .stat { display: flex; align-items: center; gap: 3px; }
        .stat-label { font-size: 0.55rem; color: var(--dim); text-transform: uppercase; }
        .stat-value { font-size: 0.8rem; font-weight: bold; }
        .stat-value.green { color: var(--green); }
        .stat-value.red { color: var(--red); }
        .stat-value.yellow { color: var(--yellow); }
        .stat-value.cyan { color: var(--cyan); }
        .stat-sub { font-size: 0.55rem; color: var(--dim); margin-left: 1px; }
        .stat-divider { width: 1px; height: 16px; background: var(--border); }

        /* Badge styles */
        .badge { padding: 2px 6px; border-radius: 8px; font-size: 0.6rem; font-weight: 600; display: inline-block; }
        .badge.green { background: rgba(0, 255, 136, 0.2); color: var(--green); }
        .badge.yellow { background: rgba(255, 170, 0, 0.2); color: var(--yellow); }
        .badge.red { background: rgba(255, 68, 102, 0.2); color: var(--red); }
        .badge.cyan { background: rgba(0, 204, 255, 0.2); color: var(--cyan); }

        /* Health bar inline */
        .health-bar { width: 40px; height: 4px; background: var(--bg); border-radius: 2px; overflow: hidden; display: inline-block; vertical-align: middle; margin-left: 4px; }
        .health-bar-fill { height: 100%; border-radius: 2px; }

        /* Drawdown levels inline */
        .dd-levels { display: inline-flex; gap: 2px; vertical-align: middle; margin-left: 4px; }
        .dd-level { width: 8px; height: 4px; border-radius: 2px; background: var(--bg); }
        .dd-level.on { background: var(--yellow); }
        .dd-level.danger { background: var(--red); }

        /* Main Grid - 3 columns */
        .main-grid { display: grid; grid-template-columns: 180px 1fr 180px; gap: 6px; }
        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 600px) { .main-grid { grid-template-columns: 1fr; } }

        /* Cards */
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 8px; }
        .card-title { font-size: 0.65rem; font-weight: 600; color: var(--dim); text-transform: uppercase; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }

        /* Input Card */
        .dir-btns { display: flex; gap: 3px; margin-bottom: 4px; }
        .dir-btn { flex: 1; padding: 8px 4px; border: 1px solid var(--border); border-radius: 4px; font-size: 0.75rem; font-weight: bold; cursor: pointer; background: var(--bg2); transition: all 0.15s; }
        .dir-btn.up { color: var(--green); }
        .dir-btn.up:hover, .dir-btn.up.selected { background: rgba(0, 255, 136, 0.2); border-color: var(--green); }
        .dir-btn.down { color: var(--red); }
        .dir-btn.down:hover, .dir-btn.down.selected { background: rgba(255, 68, 102, 0.2); border-color: var(--red); }
        .input-row { display: flex; gap: 3px; }
        .pct-input { flex: 1; padding: 6px; font-size: 0.85rem; text-align: center; background: var(--bg2); border: 1px solid var(--border); border-radius: 4px; color: var(--text); outline: none; }
        .pct-input:focus { border-color: var(--cyan); }
        .add-btn { padding: 6px 10px; background: linear-gradient(135deg, var(--cyan), var(--purple)); border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; font-size: 0.8rem; }
        .quick-btns { display: flex; gap: 2px; margin-top: 4px; }
        .quick-btn { flex: 1; padding: 3px; background: var(--bg2); border: 1px solid var(--border); border-radius: 3px; color: var(--dim); cursor: pointer; font-size: 0.6rem; }
        .quick-btn:hover { border-color: var(--cyan); color: var(--text); }
        .actions { display: flex; gap: 3px; margin-top: 6px; }
        .act-btn { flex: 1; padding: 4px; background: var(--bg2); border: 1px solid var(--border); border-radius: 3px; color: var(--text); cursor: pointer; font-size: 0.7rem; }
        .act-btn:hover { border-color: var(--cyan); }
        .act-btn.danger:hover { border-color: var(--red); color: var(--red); }

        /* Blocks Display */
        .blocks-grid { display: flex; flex-wrap: wrap; gap: 2px; max-height: 80px; overflow-y: auto; }
        .blk { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; border-radius: 2px; font-size: 0.55rem; font-weight: bold; }
        .blk.up { background: var(--green); color: #000; }
        .blk.down { background: var(--red); color: #fff; }

        /* Prediction */
        .pred-box { text-align: center; padding: 6px; background: var(--bg2); border-radius: 4px; }
        .pred-dir { font-size: 1.2rem; font-weight: bold; }
        .pred-dir.up { color: var(--green); }
        .pred-dir.down { color: var(--red); }
        .pred-dir.none { color: var(--dim); }
        .pred-pattern { color: var(--cyan); font-size: 0.65rem; margin-top: 2px; }
        .pred-reason { color: var(--dim); font-size: 0.55rem; margin-top: 2px; }

        /* Pending Trade */
        .pending { background: rgba(255, 170, 0, 0.1); border: 1px solid var(--yellow); border-radius: 4px; padding: 4px 8px; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; font-size: 0.65rem; }
        .pending.hidden { display: none; }
        .pending-dir { font-weight: bold; font-size: 0.8rem; }
        .pending-dir.up { color: var(--green); }
        .pending-dir.down { color: var(--red); }

        /* Patterns Table */
        .patterns { font-size: 0.6rem; }
        .patterns table { width: 100%; border-collapse: collapse; }
        .patterns th, .patterns td { padding: 2px 4px; text-align: left; border-bottom: 1px solid var(--border); }
        .patterns th { color: var(--dim); font-size: 0.55rem; text-transform: uppercase; }
        .p-dot { display: inline-block; width: 5px; height: 5px; border-radius: 50%; margin-right: 3px; }
        .p-dot.active { background: var(--green); }
        .p-dot.observing { background: var(--yellow); }
        .p-dot.broken { background: var(--red); }

        /* Profit Tracking Card (AP, AAP, BSP) */
        .profit-card { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 8px; margin-top: 6px; }
        .profit-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .profit-col { text-align: center; padding: 6px; background: var(--bg2); border-radius: 4px; }
        .profit-label { font-size: 0.55rem; color: var(--dim); text-transform: uppercase; margin-bottom: 4px; }
        .profit-value { font-size: 1rem; font-weight: bold; }
        .profit-value.green { color: var(--green); }
        .profit-value.red { color: var(--red); }
        .profit-value.yellow { color: var(--yellow); }
        .profit-desc { font-size: 0.5rem; color: var(--dim); margin-top: 2px; }
        .profit-totals { display: flex; justify-content: space-between; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); }

        /* Trades List */
        .trades { max-height: 150px; overflow-y: auto; font-size: 0.6rem; }
        .trade { display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px solid var(--border); }
        .trade:last-child { border-bottom: none; }
        .trade-win { color: var(--green); }
        .trade-loss { color: var(--red); }

        /* Connection Status */
        .conn { position: fixed; top: 4px; right: 4px; padding: 3px 8px; border-radius: 10px; font-size: 0.6rem; font-weight: 600; z-index: 100; }
        .conn.on { background: rgba(0, 255, 136, 0.2); color: var(--green); }
        .conn.off { background: rgba(255, 68, 102, 0.2); color: var(--red); }

        /* Modal */
        .modal-bg { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-bg.hidden { display: none; }
        .modal { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 10px; max-width: 300px; width: 90%; max-height: 50vh; overflow-y: auto; }
        .modal-title { font-size: 0.75rem; font-weight: 600; margin-bottom: 8px; display: flex; justify-content: space-between; }
        .modal-close { background: none; border: none; color: var(--dim); font-size: 0.9rem; cursor: pointer; }
        .session-item { padding: 6px; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 3px; cursor: pointer; font-size: 0.6rem; }
        .session-item:hover { border-color: var(--cyan); }

        /* Recovery info */
        .rec-info { background: var(--bg2); border-radius: 3px; padding: 4px; font-size: 0.55rem; color: var(--dim); }
    </style>
</head>
<body>
    <div class="conn off" id="conn">Offline</div>
    <div class="container">
        <!-- Alert -->
        <div class="alert hidden" id="alert"><span id="alertIcon">‚ö†Ô∏è</span><span id="alertMsg">Warning</span></div>

        <!-- Pending Trade -->
        <div class="pending hidden" id="pending">
            <div><span style="color:var(--dim)">PENDING:</span> <span class="pending-dir" id="pendingDir">‚ñ≤</span> <span id="pendingPat">-</span></div>
            <span style="color:var(--dim)" id="pendingReason">-</span>
        </div>

        <!-- Stats Card -->
        <div class="stats-card">
            <div class="stats-row">
                <div class="stat"><span class="stat-label">State</span><span id="state"><span class="badge yellow">UNPLAY</span></span></div>
                <div class="stat-divider"></div>
                <div class="stat"><span class="stat-label">Health</span><span class="stat-value green" id="health">100</span><div class="health-bar"><div class="health-bar-fill" id="healthBar" style="width:100%;background:var(--green)"></div></div></div>
                <div class="stat"><span class="stat-label">Mode</span><span id="mode" class="badge green">NORMAL</span></div>
                <div class="stat-divider"></div>
                <div class="stat"><span class="stat-label">Blk</span><span class="stat-value cyan" id="blocks">0</span><span class="stat-sub">(run:<span id="run">0</span>)</span></div>
                <div class="stat"><span class="stat-label">Trades</span><span class="stat-value" id="trades">0</span><span class="stat-sub">(<span id="winRate">0%</span>)</span></div>
                <div class="stat-divider"></div>
                <div class="stat"><span class="stat-label">P/L</span><span class="stat-value" id="pnl">R0</span><span class="stat-sub">(<span id="target">0%</span>)</span></div>
                <div class="stat"><span class="stat-label">DD</span><span class="stat-value" id="dd">R0</span><div class="dd-levels" id="ddLevels"><div class="dd-level"></div><div class="dd-level"></div><div class="dd-level"></div><div class="dd-level"></div></div></div>
                <div class="stat"><span class="stat-label">Stake</span><span class="stat-value green" id="stake">100%</span></div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Column 1 - Input & Blocks -->
            <div class="card">
                <div class="card-title">Input <span style="font-weight:normal;font-size:0.55rem">G/R+Enter</span></div>
                <div class="dir-btns">
                    <button class="dir-btn up" id="btnUp" onclick="selDir('up')">‚ñ≤ UP</button>
                    <button class="dir-btn down" id="btnDown" onclick="selDir('down')">‚ñº DN</button>
                </div>
                <div class="input-row">
                    <input type="number" class="pct-input" id="pctIn" placeholder="%" min="0" max="100">
                    <button class="add-btn" onclick="addBlock()">+</button>
                </div>
                <div class="quick-btns">
                    <button class="quick-btn" onclick="setPct(30)">30</button>
                    <button class="quick-btn" onclick="setPct(45)">45</button>
                    <button class="quick-btn" onclick="setPct(55)">55</button>
                    <button class="quick-btn" onclick="setPct(65)">65</button>
                    <button class="quick-btn" onclick="setPct(75)">75</button>
                </div>
                <div class="actions">
                    <button class="act-btn" onclick="undo()">‚Ü©</button>
                    <button class="act-btn" onclick="save()">üíæ</button>
                    <button class="act-btn" onclick="openLoad()">üìÇ</button>
                    <button class="act-btn danger" onclick="clear()">üóë</button>
                </div>
                <div class="card-title" style="margin-top:8px;margin-bottom:4px">Blocks</div>
                <div class="blocks-grid" id="blocksGrid"><span style="color:var(--dim)">-</span></div>
            </div>

            <!-- Column 2 - Prediction, Health, Patterns -->
            <div>
                <!-- Prediction + Health -->
                <div class="card">
                    <div style="display:flex;gap:10px;align-items:flex-start">
                        <div class="pred-box" style="flex:1">
                            <div class="pred-dir none" id="predDir">HOLD</div>
                            <div class="pred-pattern" id="predPat">-</div>
                            <div class="pred-reason" id="predReason">No pattern</div>
                        </div>
                        <div style="flex:1;font-size:0.65rem">
                            <div style="margin-bottom:4px"><span class="badge" id="healthBadge">PLAYABLE</span></div>
                            <div style="display:grid;gap:2px">
                                <div><span style="color:var(--dim)">WR:</span> <span id="wrFactor">100%</span> <span style="color:var(--dim)">VD:</span> <span id="verdict">100%</span></div>
                                <div><span style="color:var(--dim)">PT:</span> <span id="patFactor">100%</span> <span style="color:var(--dim)">DD:</span> <span id="ddFactor">100%</span></div>
                            </div>
                            <div class="rec-info hidden" id="recInfo" style="margin-top:4px"></div>
                        </div>
                    </div>
                </div>

                <!-- Profit Tracking (AP, AAP, BSP) -->
                <div class="profit-card">
                    <div class="card-title">Profit Analysis</div>
                    <div class="profit-grid">
                        <div class="profit-col">
                            <div class="profit-label">AP (Actual)</div>
                            <div class="profit-value" id="profitAP">R0</div>
                            <div class="profit-desc">Real trades only</div>
                        </div>
                        <div class="profit-col">
                            <div class="profit-label">AAP (Activation)</div>
                            <div class="profit-value yellow" id="profitAAP">0%</div>
                            <div class="profit-desc">Pattern activation</div>
                        </div>
                        <div class="profit-col">
                            <div class="profit-label">BSP (Bait/Switch)</div>
                            <div class="profit-value" id="profitBSP">0%</div>
                            <div class="profit-desc">Reverse sim (locked)</div>
                        </div>
                    </div>
                    <div class="profit-totals">
                        <span style="color:var(--dim);font-size:0.55rem">TOTALS:</span>
                        <span id="profitTotals" style="font-size:0.6rem">AP: R0 | AAP: 0% | BSP: 0%</span>
                    </div>
                </div>

                <!-- Patterns -->
                <div class="card patterns" style="margin-top:6px">
                    <table><thead><tr><th>Pattern</th><th>St</th><th>Cum</th><th>All</th></tr></thead><tbody id="patternsTable"></tbody></table>
                </div>
            </div>

            <!-- Column 3 - Trades -->
            <div class="card">
                <div class="card-title">Trades</div>
                <div class="trades" id="tradesList"><span style="color:var(--dim)">No trades</span></div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-bg hidden" id="modal" onclick="if(event.target===this)closeLoad()">
        <div class="modal">
            <div class="modal-title">Load Session <button class="modal-close" onclick="closeLoad()">√ó</button></div>
            <div id="sessions"><span style="color:var(--dim)">Loading...</span></div>
        </div>
    </div>

    <script>
        let ws, dir = null, state = {};

        function connect() {
            ws = new WebSocket((location.protocol === 'https:' ? 'wss:' : 'ws:') + '//' + location.host);
            ws.onopen = () => { document.getElementById('conn').className = 'conn on'; document.getElementById('conn').textContent = 'Online'; };
            ws.onclose = () => { document.getElementById('conn').className = 'conn off'; document.getElementById('conn').textContent = 'Offline'; setTimeout(connect, 2000); };
            ws.onmessage = e => handle(JSON.parse(e.data));
        }

        function handle(msg) {
            if (msg.type === 'full_state') { state = msg.data; update(); }
            else if (msg.type === 'block_added') { Object.assign(state, msg.data); state.blocks = [...(state.blocks||[]), msg.data.block]; update(); }
            else if (msg.type === 'block_undone') { state = msg.data; update(); }
            else if (msg.type === 'sessions_list') { renderSessions(msg.data || []); }
        }

        function send(action, payload = {}) { if (ws?.readyState === 1) ws.send(JSON.stringify({ action, payload })); }
        function selDir(d) { dir = d; document.getElementById('btnUp').classList.toggle('selected', d === 'up'); document.getElementById('btnDown').classList.toggle('selected', d === 'down'); document.getElementById('pctIn').focus(); }
        function setPct(v) { document.getElementById('pctIn').value = v; }
        function addBlock() { const p = document.getElementById('pctIn').value; if (!dir) return alert('Select direction'); if (!p || p < 0 || p > 100) return alert('Invalid %'); send('add_block', { direction: dir, percentage: p }); document.getElementById('pctIn').value = ''; }
        function undo() { send('undo'); }
        function save() { if (!state.blocks?.length) return alert('No data'); send('save'); }
        function openLoad() { document.getElementById('modal').classList.remove('hidden'); send('list_sessions'); }
        function closeLoad() { document.getElementById('modal').classList.add('hidden'); }
        function loadSession(p) { send('load', { path: p }); closeLoad(); }
        function clear() { if (confirm('Clear session?')) send('clear'); }
        function renderSessions(list) { const el = document.getElementById('sessions'); if (!list.length) { el.innerHTML = '<span style="color:var(--dim)">No sessions</span>'; return; } el.innerHTML = list.map(s => `<div class="session-item" onclick="loadSession('${s.path.replace(/\\/g,'\\\\')}')"><div>${new Date(s.timestamp).toLocaleString()}</div><div style="color:${s.pnl>=0?'var(--green)':'var(--red)'}">${s.pnl>=0?'+':''}R${s.pnl.toFixed(2)}</div></div>`).join(''); }

        function update() {
            const sum = state.summary || {};
            const health = state.sessionHealth || sum.sessionHealth || {};
            const dd = state.drawdown || {};
            const rec = state.recovery || {};
            const reentry = state.reentry || {};

            // State badge
            const st = sum.sessionState || 'unplayable';
            const stMap = { playable: ['PLAY', 'green'], unplayable: ['UNPLAY', 'yellow'], p1_mode: ['P1', 'red'], done: ['DONE', 'cyan'] };
            const [stText, stColor] = stMap[st] || [st, 'yellow'];
            document.getElementById('state').innerHTML = `<span class="badge ${stColor}">${stText}</span>`;

            // Health
            const score = health.score || 100;
            const hEl = document.getElementById('health');
            hEl.textContent = score.toFixed(0);
            hEl.className = 'stat-value ' + (score >= 70 ? 'green' : score >= 50 ? 'yellow' : 'red');
            const bar = document.getElementById('healthBar');
            bar.style.width = score + '%';
            bar.style.background = score >= 70 ? 'var(--green)' : score >= 50 ? 'var(--yellow)' : 'var(--red)';

            // Health badge
            const lvl = health.level || 'playable';
            const hBadge = document.getElementById('healthBadge');
            hBadge.textContent = lvl.toUpperCase();
            hBadge.className = 'badge ' + (lvl === 'playable' ? 'green' : lvl === 'caution' ? 'yellow' : 'red');

            // Mode
            const mode = sum.recoveryMode || state.recoveryMode || 'normal';
            const modeEl = document.getElementById('mode');
            modeEl.textContent = mode.toUpperCase();
            modeEl.className = 'badge ' + (mode === 'normal' ? 'green' : mode === 'recovery' ? 'yellow' : 'cyan');

            // Blocks & Run
            document.getElementById('blocks').textContent = sum.blockCount || 0;
            document.getElementById('run').textContent = state.runData?.currentLength || 0;

            // Trades & Win Rate
            document.getElementById('trades').textContent = sum.tradeCount || 0;
            document.getElementById('winRate').textContent = (sum.winRate || 0).toFixed(0) + '%';

            // P/L & Target
            const pnl = sum.pnlTotal || 0;
            const pnlEl = document.getElementById('pnl');
            pnlEl.textContent = (pnl >= 0 ? '+' : '') + 'R' + pnl.toFixed(0);
            pnlEl.className = 'stat-value ' + (pnl >= 0 ? 'green' : 'red');
            document.getElementById('target').textContent = (sum.targetProgress || 0).toFixed(0) + '%';

            // Drawdown
            const ddVal = dd.currentDrawdown || 0;
            const ddEl = document.getElementById('dd');
            ddEl.textContent = 'R' + ddVal.toFixed(0);
            ddEl.className = 'stat-value ' + (ddVal >= 0 ? 'green' : 'red');
            const ddLvl = dd.level || 0;
            document.querySelectorAll('#ddLevels .dd-level').forEach((el, i) => { el.className = 'dd-level' + (i < ddLvl ? (i >= 2 ? ' danger' : ' on') : ''); });

            // Stake
            const stake = sum.stakeMultiplier || 1;
            const stakeEl = document.getElementById('stake');
            stakeEl.textContent = Math.round(stake * 100) + '%';
            stakeEl.className = 'stat-value ' + (stake < 1 ? 'yellow' : 'green');

            // Health factors
            document.getElementById('wrFactor').textContent = ((health.winRateFactor || 1) * 100).toFixed(0) + '%';
            document.getElementById('verdict').textContent = ((health.verdictQualityFactor || 1) * 100).toFixed(0) + '%';
            document.getElementById('patFactor').textContent = ((health.patternReliabilityFactor || 1) * 100).toFixed(0) + '%';
            document.getElementById('ddFactor').textContent = ((health.drawdownFactor || 1) * 100).toFixed(0) + '%';

            // Recovery info
            const recInfo = document.getElementById('recInfo');
            if (rec.isInRecoveryMode) { recInfo.classList.remove('hidden'); recInfo.innerHTML = `<b>Recovery</b> | Blocks: ${rec.blocksInRecovery} | Shadow WR: ${(rec.shadowWinRate*100).toFixed(0)}%`; }
            else if (reentry.isInReentry) { recInfo.classList.remove('hidden'); recInfo.innerHTML = `<b>Re-Entry</b> | ${reentry.trialTradesCompleted}/${reentry.totalTrialTrades} | Wins: ${reentry.trialWins}`; }
            else recInfo.classList.add('hidden');

            // Blocks grid
            const bg = document.getElementById('blocksGrid');
            if (state.blocks?.length) { bg.innerHTML = state.blocks.map(b => `<div class="blk ${b.dir > 0 ? 'up' : 'down'}">${b.pct.toFixed(0)}</div>`).join(''); bg.scrollTop = bg.scrollHeight; }
            else bg.innerHTML = '<span style="color:var(--dim)">No blocks</span>';

            // Prediction
            const pred = state.prediction || {};
            const predDir = document.getElementById('predDir');
            if (pred.hasPrediction) { predDir.textContent = pred.direction > 0 ? '‚ñ≤ UP' : '‚ñº DOWN'; predDir.className = 'pred-dir ' + (pred.direction > 0 ? 'up' : 'down'); document.getElementById('predPat').textContent = pred.pattern + ' (' + pred.confidence + '%)'; }
            else { predDir.textContent = 'HOLD'; predDir.className = 'pred-dir none'; document.getElementById('predPat').textContent = '-'; }
            document.getElementById('predReason').textContent = pred.reason || '';

            // Pending
            const pendEl = document.getElementById('pending');
            if (state.pendingTrade) { pendEl.classList.remove('hidden'); const pd = document.getElementById('pendingDir'); pd.textContent = state.pendingTrade.direction > 0 ? '‚ñ≤' : '‚ñº'; pd.className = 'pending-dir ' + (state.pendingTrade.direction > 0 ? 'up' : 'down'); document.getElementById('pendingPat').textContent = state.pendingTrade.pattern; document.getElementById('pendingReason').textContent = state.pendingTrade.reason; }
            else pendEl.classList.add('hidden');

            // Patterns
            const pt = document.getElementById('patternsTable');
            if (state.patterns?.length) { pt.innerHTML = state.patterns.sort((a,b) => (b.allTimeProfit||0) - (a.allTimeProfit||0)).map(p => `<tr><td><span class="p-dot ${p.state}"></span>${p.pattern}</td><td>${p.state[0].toUpperCase()}</td><td style="color:${p.cumulativeProfit>=0?'var(--green)':'var(--red)'}">${p.cumulativeProfit>=0?'+':''}${p.cumulativeProfit.toFixed(0)}%</td><td style="color:${p.allTimeProfit>=0?'var(--green)':'var(--red)'}">${p.allTimeProfit>=0?'+':''}${p.allTimeProfit.toFixed(0)}%</td></tr>`).join(''); }

            // Trades
            const tl = document.getElementById('tradesList');
            if (state.trades?.length) { tl.innerHTML = state.trades.slice().reverse().slice(0,12).map(t => `<div class="trade"><span>#${t.id} ${t.pattern}</span><span class="${t.isWin?'trade-win':'trade-loss'}">${t.isWin?'W':'L'} ${t.isWin?'+':''}R${t.pnl.toFixed(0)}</span></div>`).join(''); }
            else tl.innerHTML = '<span style="color:var(--dim)">No trades</span>';

            // Alert
            const alert = document.getElementById('alert');
            const alertIcon = document.getElementById('alertIcon');
            const alertMsg = document.getElementById('alertMsg');
            if (sum.isSessionStopped && sum.sessionStopReason) { alert.classList.remove('hidden'); alert.className = 'alert danger'; alertIcon.textContent = 'üö´'; alertMsg.textContent = sum.sessionStopReason; }
            else if (mode === 'recovery') { alert.classList.remove('hidden'); alert.className = 'alert info'; alertIcon.textContent = 'üîÑ'; alertMsg.textContent = 'Recovery - Shadow trading'; }
            else if (mode === 'reentry') { alert.classList.remove('hidden'); alert.className = 'alert warning'; alertIcon.textContent = '‚ö°'; alertMsg.textContent = `Re-entry at ${Math.round(stake*100)}% stake`; }
            else if (lvl === 'caution') { alert.classList.remove('hidden'); alert.className = 'alert warning'; alertIcon.textContent = '‚ö†Ô∏è'; alertMsg.textContent = `Health declining: ${score.toFixed(0)}/100`; }
            else alert.classList.add('hidden');

            // Profit Tracking (AP, AAP, BSP)
            const profitData = state.profitTracking?.totals || sum.profitTracking || { actualProfit: 0, activationAccumulatedProfit: 0, baitSwitchProfit: 0 };

            // AP (Actual Profit) - from real trades
            const ap = profitData.actualProfit || 0;
            const apEl = document.getElementById('profitAP');
            if (apEl) {
                apEl.textContent = (ap >= 0 ? '+' : '') + 'R' + ap.toFixed(0);
                apEl.className = 'profit-value ' + (ap >= 0 ? 'green' : 'red');
            }

            // AAP (Accumulated Activation Profit) - pattern activation accumulation
            const aap = profitData.activationAccumulatedProfit || 0;
            const aapEl = document.getElementById('profitAAP');
            if (aapEl) {
                aapEl.textContent = (aap >= 0 ? '+' : '') + aap.toFixed(0) + '%';
                aapEl.className = 'profit-value yellow';
            }

            // BSP (Bait & Switch Profit) - reverse simulation during locked periods
            const bsp = profitData.baitSwitchProfit || 0;
            const bspEl = document.getElementById('profitBSP');
            if (bspEl) {
                bspEl.textContent = (bsp >= 0 ? '+' : '') + bsp.toFixed(0) + '%';
                bspEl.className = 'profit-value ' + (bsp >= 0 ? 'green' : 'red');
            }

            // Totals row
            const totalsEl = document.getElementById('profitTotals');
            if (totalsEl) {
                totalsEl.innerHTML =
                    `<span class="${ap >= 0 ? 'green' : 'red'}">AP: ${ap >= 0 ? '+' : ''}R${ap.toFixed(0)}</span> | ` +
                    `<span class="yellow">AAP: ${aap >= 0 ? '+' : ''}${aap.toFixed(0)}%</span> | ` +
                    `<span class="${bsp >= 0 ? 'green' : 'red'}">BSP: ${bsp >= 0 ? '+' : ''}${bsp.toFixed(0)}%</span>`;
            }
        }

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') { closeLoad(); return; }
            if (e.target.tagName === 'INPUT') { if (e.key === 'Enter') addBlock(); return; }
            if (e.key.toLowerCase() === 'g') { selDir('up'); document.getElementById('pctIn').focus(); }
            if (e.key.toLowerCase() === 'r') { selDir('down'); document.getElementById('pctIn').focus(); }
            if (e.key.toLowerCase() === 'u') undo();
            if (e.key.toLowerCase() === 's') { e.preventDefault(); save(); }
        });

        connect();
    </script>
</body>
</html>
